<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Image Converter | Fast & Responsive</title>

    <!-- FAVICON -->
    <link rel="icon" href="./assets/svg/logo.svg" type="image/svg+xml">

    <!-- Preconnect for Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- JSZip library is loaded from a trusted CDN to enable ZIP file creation. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Non-blocking load for Google Fonts stylesheet -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" as="style" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'" />

    <!-- Non-blocking load for your Tailwind build -->
    <link rel="preload" href="./assets/style/style.css" as="style" />
    <link rel="stylesheet" href="./assets/style/style.css" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="./assets/style/style.css" />


    <script src="./assets/js/header.js" defer></script>
    <script src="./assets/js/footer.js" defer></script>
    <script src="./assets/js/main.js" defer></script>

</head>
<body class="bg-slate-200 font-sans text-slate-800 flex min-h-screen flex-col transition-colors duration-300 dark:bg-slate-900 dark:text-slate-200">

<div id="header-placeholder"></div>

<main class="flex-grow w-full">
    <div class="p-4 sm:p-6 mt-16 mx-auto">
        <div class="mb-4">
          <div id="topad-1" aria-label="Top Ad 1"></div>
        </div>

        <div class="lg:grid lg:grid-cols-[side_bar] lg:gap-4">

            <div class="min-w-0 overflow-hidden" id="pdf-converter-app">
            <section class="w-full max-w-4xl mx-auto bg-white p-4 sm:p-6 lg:p-8 rounded-2xl border border-indigo-300 dark:bg-slate-800 dark:border-slate-700">
                <div class="text-center mb-8">
                    <h1 class="text-3xl lg:text-4xl p-1 font-extrabold bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 bg-clip-text text-transparent">Professional Image Converter</h1>
                    <p class="mt-2 max-w-2xl mx-auto text-lg text-slate-600 dark:text-slate-400">Batch convert images to PNG, JPG, or WebP. Adjust quality and download all as a ZIP—conversions happen securely in your browser.</p>
                </div>
                
                <div id="upload-area" class="w-full max-w-2xl mx-auto">
                    <!-- This is a label for the hidden file input. The browser handles the click forwarding natively. -->
                    <label for="upload-input" class="block text-center p-8 border-2 border-dashed border-slate-400 dark:border-slate-500 rounded-lg cursor-pointer transition-colors hover:border-indigo-600 dark:hover:border-indigo-300 bg-slate-200 dark:bg-slate-900">
                        <div class="flex flex-col items-center justify-center space-y-4">
                            <p class="text-lg font-medium text-slate-700 dark:text-slate-300">Drag & drop your Images here</p>
                            <span class="text-slate-500 text-lg font-medium dark:text-slate-400">or</span>
                            <span class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-semibold py-2.5 px-5 rounded-md text-lg">Select Images</span>
                            <p class="flex items-center text-sm text-slate-500 dark:text-slate-400 pt-2">
                                <svg class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                                Files are processed locally & never leave your device.
                            </p>
                        </div>
                    </label>
                    <input type="file" id="upload-input" accept="image/*" class="hidden" multiple>
                </div>

                <div class="mt-4 flex justify-center items-center gap-4 flex-wrap hidden" id="file-info-bar">
                    <span id="file-count"></span>
                    <button id="clear-all-btn" class="w-full sm:w-auto text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-base px-5 py-3 transition-colors dark:bg-indigo-500 dark:hover:bg-indigo-600">Clear All</button>
                </div>

                <div id="preview-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6 mt-8 hidden"></div>

                <div class="controls-wrapper mt-8 max-w-3xl mx-auto hidden">
                    <div class="controls grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="control-group flex flex-col">
                            <label for="format" class="font-semibold mb-2">Target Format:</label>
                            <select id="format" class="w-full p-2 border border-slate-300 rounded-md dark:bg-slate-700 dark:border-slate-600">
                                <option value="png">PNG</option>
                                <option value="jpeg" selected>JPG</option>
                                <option value="webp">WebP</option>
                            </select>
                        </div>
                        <div class="control-group quality-control" id="quality-control"> <!-- Class 'hidden' is managed by JS -->
                            <label for="quality" class="font-semibold mb-2">Quality:</label>
                            <div class="flex items-center gap-3">
                                <input type="range" id="quality" min="10" max="100" value="100" class="w-full">
                                <span id="quality-value" class="font-bold text-indigo-600 dark:text-indigo-300 text-lg">100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="progress-container mt-6">
                        <progress id="progress-bar" value="0" max="100" class="w-full h-2.5 rounded-md [&::-webkit-progress-bar]:bg-slate-200 [&::-webkit-progress-value]:bg-indigo-600 dark:[&::-webkit-progress-bar]:bg-slate-700" style="visibility: hidden;"></progress>
                        <div id="status-message" class="font-medium text-lg text-slate-600 dark:text-slate-300 text-center mt-2"></div>
                    </div>

                    <div class="actions mt-8 flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="convert-btn" class="flex-1 text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-lg px-5 py-3 transition-all dark:bg-indigo-500 dark:hover:bg-indigo-600" disabled>Convert</button>
                        <button id="zip-btn" class="flex-1 text-white bg-green-600 hover:bg-green-700 font-semibold rounded-lg text-lg px-5 py-3 transition-all dark:bg-green-500 dark:hover:bg-green-600 hidden">Download as ZIP</button>
                    </div>
                </div>
            </section>

                <div class="my-4">
                    <div id="midad-1" aria-label="Mid Ad 1"></div>
                </div>
            </div>

            <aside class="hidden lg:flex flex-col">
              <div id="sidead-1" aria-label="Sidebar Ad 1"></div>
            </aside>

            <aside class="hidden lg:flex flex-col">
              <div id="sidead-2" aria-label="Sidebar Ad 2"></div>
            </aside>
            
        </div>
        <div class="mb-4">
          <div id="topad-2" aria-label="Top Ad 2"></div>
        </div>
    </div>
</main>

<div id="footer-placeholder"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Element References ---
    const uploadArea = document.getElementById('upload-area');
    const uploadInput = document.getElementById('upload-input');
    const fileInfoBar = document.getElementById('file-info-bar');
    const fileCountEl = document.getElementById('file-count');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const previewGrid = document.getElementById('preview-grid');
    const controlsWrapper = document.querySelector('.controls-wrapper');
    const formatSelect = document.getElementById('format');
    const qualityControl = document.getElementById('quality-control');
    const qualityInput = document.getElementById('quality');
    const qualityValue = document.getElementById('quality-value');
    const convertBtn = document.getElementById('convert-btn');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const zipBtn = document.getElementById('zip-btn');

    // --- Application State ---
    let filesToProcess = [];
    let convertedFiles = [];
    let isConverting = false;

    // --- Utility Functions ---
    const preventDefaults = e => {
        e.preventDefault();
        e.stopPropagation();
    };
    
    const formatFileSize = (bytes) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };
    
    // --- UI Update Functions ---

    const updateUIState = () => {
        const hasFiles = filesToProcess.length > 0;
        
        fileInfoBar.classList.toggle('hidden', !hasFiles);
        previewGrid.classList.toggle('hidden', !hasFiles);
        controlsWrapper.classList.toggle('hidden', !hasFiles);
        uploadArea.classList.toggle('hidden', hasFiles);

        if (hasFiles) {
            fileCountEl.textContent = `${filesToProcess.length} file(s) selected`;
        }
        
        convertBtn.disabled = !hasFiles || isConverting;
        zipBtn.classList.toggle('hidden', convertedFiles.length === 0);
    };

    const setControlsDisabled = (disabled) => {
        isConverting = disabled;
        convertBtn.disabled = disabled || filesToProcess.length === 0;
        uploadArea.style.pointerEvents = disabled ? 'none' : 'auto';
        clearAllBtn.disabled = disabled;
        formatSelect.disabled = disabled;
        qualityInput.disabled = disabled;
        
        // Disable remove buttons on previews during conversion
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.disabled = disabled;
        });
    };

    const toggleQualityControl = () => {
        const format = formatSelect.value;
        qualityControl.classList.toggle('hidden', format !== 'jpeg' && format !== 'webp');
    };

    const resetConvertedState = () => {
        convertedFiles = [];
        zipBtn.classList.add('hidden');
        progressBar.style.visibility = 'hidden';
        progressBar.value = 0;
        statusMessage.textContent = '';
        
        document.querySelectorAll('.result-overlay').forEach(el => el.remove());
        updateUIState();
    };
    
    // --- Core Logic Functions ---

    const resetAll = () => {
        filesToProcess = [];
        convertedFiles = []; // Also clear converted files
        uploadInput.value = ''; // Ensure input is cleared
        previewGrid.innerHTML = ''; 
        resetConvertedState();
    };

    const addFilesToQueue = (files) => {
        if (isConverting) return;
        
        let newFilesAdded = false;
        for (const file of files) {
            // Validate file type and check for duplicates
            if (file.type.startsWith('image/') && !filesToProcess.some(f => f.file.name === file.name)) {
                const fileData = {
                    id: `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    file: file,
                    name: file.name
                };
                filesToProcess.push(fileData);
                
                // Create and append the preview card for the new file
                const previewCard = createPreviewCard(fileData);
                previewGrid.appendChild(previewCard);
                newFilesAdded = true;
            }
        }
        
        if (newFilesAdded) {
            resetConvertedState(); // If new files are added, previous conversion is invalid
        }
        
        // IMPORTANT: Clear the input value to allow selecting the same file again
        uploadInput.value = '';
    };

    const removeFile = (fileId) => {
        // Find the file to remove
        const fileToRemove = filesToProcess.find(f => f.id === fileId);
        if (!fileToRemove) return;

        // Remove from the main file list
        filesToProcess = filesToProcess.filter(f => f.id !== fileId);
        
        // Also remove from the converted files list to keep ZIP in sync
        convertedFiles = convertedFiles.filter(cf => cf.originalName !== fileToRemove.name);

        // Remove the preview card from the DOM
        document.getElementById(fileId)?.remove();

        if (filesToProcess.length === 0) {
            resetAll();
        } else {
            updateUIState();
        }
    };

    const convertSingleImage = (fileData) => {
        return new Promise((resolve, reject) => {
            const objectURL = URL.createObjectURL(fileData.file);
            const img = new Image();
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                
                const format = formatSelect.value;
                // For formats that don't support transparency, draw a white background
                if (format === 'jpeg') {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(objectURL); // Revoke URL after drawing to free memory
                
                const mimeType = `image/${format}`;
                const quality = (format === 'jpeg' || format === 'webp') ? (qualityInput.value / 100) : undefined;
                
                canvas.toBlob(blob => {
                    if (!blob) {
                        return reject(new Error('Canvas toBlob operation failed.'));
                    }
                    const baseName = fileData.name.substring(0, fileData.name.lastIndexOf('.')) || fileData.name;
                    resolve({
                        blob,
                        newName: `${baseName}.${format}`,
                        originalName: fileData.name,
                        size: formatFileSize(blob.size),
                    });
                }, mimeType, quality);
            };

            img.onerror = () => {
                URL.revokeObjectURL(objectURL);
                reject(new Error("Image failed to load."));
            };

            img.src = objectURL;
        });
    };
    
    async function processConversion() {
        if (filesToProcess.length === 0 || isConverting) return;
        
        setControlsDisabled(true);
        resetConvertedState();
        progressBar.style.visibility = 'visible';
        
        let convertedCount = 0;
        const totalFiles = filesToProcess.length;

        for (const fileData of filesToProcess) {
            try {
                const result = await convertSingleImage(fileData);
                convertedFiles.push(result);
                displayResultOnPreview(fileData.id, result.size, false);
            } catch (error) {
                console.error("Conversion error for", fileData.name, error);
                displayResultOnPreview(fileData.id, "Error", true);
            }
            
            convertedCount++;
            const progress = (convertedCount / totalFiles) * 100;
            progressBar.value = progress;
            
            // Throttle DOM updates to prevent UI lag on large batches
            if (convertedCount % 5 === 0 || convertedCount === totalFiles) {
                statusMessage.textContent = `Converting... (${convertedCount}/${totalFiles})`;
            }
        }
        
        statusMessage.textContent = "Conversion Complete!";
        setControlsDisabled(false);
        updateUIState();
    }
    
    async function downloadAllAsZip() {
        if (convertedFiles.length === 0) return;
        
        zipBtn.disabled = true;
        statusMessage.textContent = "Zipping files...";

        try {
            if (typeof JSZip === 'undefined') {
                throw new Error("Zipping library (JSZip) not found.");
            }
            const zip = new JSZip();
            convertedFiles.forEach(file => {
                zip.file(file.newName, file.blob);
            });
            
            const zipBlob = await zip.generateAsync({ type: "blob", compression: "DEFLATE" });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = `converted_images_${Date.now()}.zip`;
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Clean up
            
            statusMessage.textContent = "ZIP download started.";
        } catch(error) {
            statusMessage.textContent = `Error: ${error.message}`;
            console.error("ZIP Error:", error);
        } finally {
            zipBtn.disabled = false;
        }
    }


    // --- Dynamic Element Creation ---

    function createPreviewCard(fileData) {
        const item = document.createElement('div');
        item.className = 'result-card relative group bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg overflow-hidden flex flex-col shadow-sm';
        item.id = fileData.id;
        
        const img = document.createElement('img');
        const objectUrl = URL.createObjectURL(fileData.file);
        img.src = objectUrl;
        img.alt = fileData.name;
        // Revoke the object URL once the image has loaded to free up memory
        img.onload = () => URL.revokeObjectURL(objectUrl);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn absolute z-10 flex flex-col p-1 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer';
        removeBtn.title = "Remove file";
        removeBtn.innerHTML = '❌'; // Use HTML entity for a cleaner 'X'
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            removeFile(fileData.id);
        });
        
        item.append(img, removeBtn);
        return item;
    }
    
    function displayResultOnPreview(id, text, isError) {
        const previewItem = document.getElementById(id);
        if (!previewItem) return;
        
        const overlay = document.createElement('div');
        overlay.className = 'result-overlay absolute bottom-0 left-0 right-0 p-1 text-center text-base text-white font-semibold';
        overlay.style.backgroundColor = isError ? 'rgba(239, 68, 68, 0.85)' : 'rgba(21, 128, 61, 0.85)';
        overlay.innerHTML = isError ? text : `✓ ${text}`;
        
        // Remove old overlay if it exists, then add the new one
        previewItem.querySelector('.result-overlay')?.remove();
        previewItem.appendChild(overlay);
    }
    
    // --- Initial Setup and Event Listeners ---
    
    // Drag & Drop event listeners
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, preventDefaults));
    ['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, () => !isConverting && uploadArea.classList.add('highlight')));
    ['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('highlight')));
    
    uploadArea.addEventListener('drop', (e) => {
        addFilesToQueue(e.dataTransfer.files);
    });

    uploadInput.addEventListener('change', (e) => {
        addFilesToQueue(e.target.files);
    });
    
    clearAllBtn.addEventListener('click', resetAll);
    formatSelect.addEventListener('change', () => {
        toggleQualityControl();
        // Changing format invalidates previous conversion
        if (convertedFiles.length > 0) resetConvertedState();
    });
    
    qualityInput.addEventListener('input', e => qualityValue.textContent = `${e.target.value}%`);
    convertBtn.addEventListener('click', processConversion);
    zipBtn.addEventListener('click', downloadAllAsZip);

    // Initial UI state setup
    toggleQualityControl();
    updateUIState();
});
</script>

</body>
</html>
