<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Advanced PDF Extractor - Offline & Secure</title>

    <!-- FAVICON -->
    <link rel="icon" href="./assets/svg/logo.svg" type="image/svg+xml">

    <!-- Preconnect for Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- DEFERRED SCRIPTS FOR FASTER PAGE LOAD -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    
    <!-- Non-blocking load for Google Fonts stylesheet -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" as="style" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" />

    <!-- Non-blocking load for your Tailwind build -->
    <link rel="preload" href="./assets/style/style.css" as="style" />
    <link rel="stylesheet" href="./assets/style/style.css" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="./assets/style/style.css" />

    <script src="./assets/js/header.js" defer></script>
    <script src="./assets/js/footer.js" defer></script>
    <script src="./assets/js/main.js" defer></script>

</head>
<body class="bg-slate-200 font-sans text-slate-800 flex min-h-screen flex-col transition-colors duration-300 dark:bg-slate-900 dark:text-slate-200">

<div id="header-placeholder"></div>

<main class="flex-grow w-full">
    <div class="p-4 sm:p-6 mt-16 mx-auto">
        <div class="mb-4">
          <div id="topad-1" aria-label="Top Ad 1"></div>
        </div>

        <div class="lg:grid lg:grid-cols-[side_bar] lg:gap-4">

            <div class="min-w-0 overflow-hidden" id="pdf-converter-app">
                <section class="w-full max-w-4xl mx-auto bg-white p-4 sm:p-6 lg:p-8 rounded-2xl border border-indigo-300 dark:bg-slate-800 dark:border-slate-700">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl lg:text-4xl p-1 font-extrabold bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 bg-clip-text text-transparent">Secure PDF to PNG Converter</h1>
                        <p class="mt-2 max-w-2xl mx-auto text-lg text-slate-600 dark:text-slate-400">Convert PDF pages to high-quality PNG imagesâ€”securely in your browser.</p>
                    </div>

                    <!-- Step 1: Upload -->
                    <section id="upload-section">
                        <div id="upload-area" class="w-full max-w-2xl mx-auto">
                            <label for="file-input" class="block text-center p-8 border-2 border-dashed border-slate-400 dark:border-slate-500 rounded-lg cursor-pointer transition-colors hover:border-indigo-600 dark:hover:border-indigo-300 bg-slate-200 dark:bg-slate-900">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <p class="text-lg font-medium text-slate-700 dark:text-slate-300">Drag & drop your PDF file here</p>
                                    <span class="text-slate-500 text-lg font-medium dark:text-slate-400">or</span>
                                    <span class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-semibold py-2.5 px-5 rounded-md text-lg">Select a PDF</span>
                                    <p class="flex items-center text-sm text-slate-500 dark:text-slate-400 pt-2">
                                        <svg class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                                        Files are processed locally & never leave your device.
                                    </p>
                                </div>
                            </label>
                            <input type="file" id="file-input" accept=".pdf" class="hidden">
                        </div>
                        <div id="file-info-container" class="mt-4 flex justify-center items-center gap-4 flex-wrap hidden">
                            <p id="file-info" class="font-semibold text-indigo-600 dark:text-indigo-400 text-center"></p>
                            <button id="reset-btn" class="w-full sm:w-auto text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-base px-5 py-3 transition-colors dark:bg-indigo-500 dark:hover:bg-indigo-600">Start Over</button>
                        </div>
                    </section>

                    <!-- Step 2: Controls -->
                    <section id="controls" class="hidden mt-8 max-w-3xl mx-auto">
                         <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 border-b border-slate-300 dark:border-slate-600 pb-3">2. Convert to PNG</h2>
                         <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Your PDF will be converted to high-quality PNG images, one for each page. Click the button below to start.</p>
                        <div class="mt-8 flex flex-col sm:flex-row gap-4">
                            <button id="convert-btn" class="flex-1 text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-lg px-5 py-3 transition-all dark:bg-indigo-500 dark:hover:bg-indigo-600">Convert to PNG</button>
                        </div>
                    </section>
                    
                    <!-- Status & Results -->
                    <div id="status-area" class="text-center mt-6 hidden">
                        <div id="progress-bar-container" class="w-full max-w-xs mx-auto bg-slate-200 dark:bg-slate-700 rounded-md h-2.5 my-4 overflow-hidden">
                            <div id="progress-bar" class="bg-indigo-600 dark:bg-indigo-500 h-2.5 rounded-md transition-all duration-300" style="width:0%"></div>
                        </div>
                        <p id="progress-message" role="status" class="font-medium text-lg text-slate-600 dark:text-slate-300"></p>
                    </div>
                     <div id="error-message" role="alert" class="mt-4 font-medium text-red-500 p-4 text-center hidden"></div>

                    <section id="results-container" class="mt-8 hidden">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 border-b border-slate-300 dark:border-slate-600 pb-3">3. Your Files</h2>
                         <div class="mt-6 flex flex-col sm:flex-row gap-4">
                            <button id="download-zip-btn" class="flex-1 text-white bg-green-600 hover:bg-green-700 font-semibold rounded-lg text-lg px-5 py-3 transition-all dark:bg-green-500 dark:hover:bg-green-600">Download All as ZIP</button>
                        </div>
                        <div id="results-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6 mt-8">
                            <!-- JS will render results here -->
                        </div>
                    </section>
                </section>

                <div class="my-4">
                    <div id="midad-1" aria-label="Mid Ad 1"></div>
                </div>
            </div>

            <aside class="hidden lg:flex flex-col">
              <div id="sidead-1" aria-label="Sidebar Ad 1"></div>
            </aside>

            <aside class="hidden lg:flex flex-col">
              <div id="sidead-2" aria-label="Sidebar Ad 2"></div>
            </aside>
            
        </div>
        <div class="mb-4">
          <div id="topad-2" aria-label="Top Ad 2"></div>
        </div>
    </div>
</main>

<div id="footer-placeholder"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileInfoContainer = document.getElementById('file-info-container');
        const fileInfo = document.getElementById('file-info');
        const resetBtn = document.getElementById('reset-btn');
        const controlsSection = document.getElementById('controls');
        const convertBtn = document.getElementById('convert-btn');
        const statusArea = document.getElementById('status-area');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');
        const errorMessage = document.getElementById('error-message');
        const resultsContainer = document.getElementById('results-container');
        const downloadZipBtn = document.getElementById('download-zip-btn');
        const resultsList = document.getElementById('results-list');

        // --- State ---
        let state = {
            file: null,
            fileName: '',
            isConverting: false,
            resultsVisible: false,
            progressText: '',
            errorText: '',
            convertedImages: [],
        };
        
        // Helper function to allow the browser to repaint between tasks.
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- UI Update Function ---
        function render() {
            // Section visibility
            uploadArea.classList.toggle('hidden', !!state.file);
            fileInfoContainer.classList.toggle('hidden', !state.file);
            controlsSection.classList.toggle('hidden', !(state.file && !state.isConverting && !state.resultsVisible));
            statusArea.classList.toggle('hidden', !state.progressText && !state.isConverting);
            resultsContainer.classList.toggle('hidden', !state.resultsVisible);
            errorMessage.classList.toggle('hidden', !state.errorText);

            // Text content
            fileInfo.textContent = state.fileName;
            progressMessage.textContent = state.progressText;
            errorMessage.textContent = state.errorText;

            // Render image results
            if (state.resultsVisible && resultsList.children.length !== state.convertedImages.length) {
                resultsList.innerHTML = ''; // Clear previous
                state.convertedImages.forEach((image, index) => {
                    const card = document.createElement('div');
                    card.className = 'result-card relative group bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg overflow-hidden flex flex-col shadow-sm';
                    card.innerHTML = `
                        <div class="w-full h-48 flex items-center justify-center p-2 bg-slate-100 dark:bg-slate-700">
                           <img src="${image.data}" alt="Preview for Page ${index + 1}" class="max-w-full max-h-full object-contain">
                        </div>
                        <div class="p-2 border-t border-indigo-300 text-center">
                           <span class="block font-semibold truncate">Page ${index + 1}</span>
                           <a href="${image.data}" download="Page_${index + 1}.png" class="mt-2 inline-block w-full rounded-md bg-indigo-500 py-2 px-3 text-sm font-semibold text-white transition hover:bg-indigo-600">Download</a>
                        </div>
                    `;
                    resultsList.appendChild(card);
                });
            }
        }

        // --- Event Handlers ---
        function handleFileSelect(event) {
            const selectedFile = event.target.files[0];
            if (!selectedFile) return;

            resetState();

            if (selectedFile.type !== "application/pdf") {
                return showError("Please select a valid PDF file.");
            }

            if (selectedFile.size > 1500 * 1024 * 1024) { 
                return showError("File is too large (Max 1500MB).");
            }
            
            state.file = selectedFile;
            state.fileName = `âœ“ ${selectedFile.name}`;
            hideError();
            render();
        }

        async function processPDF() {
            if (!state.file) return;

            state.isConverting = true;
            state.progressText = "Preparing to convert...";
            progressBarContainer.classList.remove('hidden'); 
            progressBar.style.width = '0%';
            hideError();
            render();

            try {
                const fileData = await state.file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(fileData), useSystemFonts: true }).promise;
                const numPages = pdf.numPages;

                for (let i = 1; i <= numPages; i++) {
                    state.progressText = `Converting page ${i} of ${numPages}...`;
                    const progress = ((i / numPages) * 100);
                    progressBar.style.width = `${progress}%`; 
                    render();
                    
                    // Allow UI to update before this heavy task, preventing a frozen interface.
                    await sleep(0);

                    const page = await pdf.getPage(i);
                    const scale = 2.0;
                    const viewport = page.getViewport({ scale });
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport }).promise;
                    state.convertedImages.push({ data: canvas.toDataURL("image/png") });
                }
                
                state.isConverting = false;
                state.resultsVisible = true;
                state.progressText = "Conversion Complete!";
                render();

            } catch (err) {
                console.error("PDF Processing Error:", err);
                showError("Could not process PDF. It may be encrypted or corrupted.");
                resetState();
            } finally {
               state.isConverting = false;
               progressBarContainer.classList.add('hidden');
               render();
            }
        }
        
        async function downloadZip() {
            if (state.convertedImages.length === 0) return;

            downloadZipBtn.disabled = true;
            state.isConverting = true; // Use this to show the status area
            progressBarContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            
            try {
                const zip = new JSZip();
                const totalFiles = state.convertedImages.length;
                
                for (let i = 0; i < totalFiles; i++) {
                    const image = state.convertedImages[i];
                    state.progressText = `Zipping image ${i + 1} of ${totalFiles}...`;
                    
                    const base64Data = image.data.split(",")[1];
                    zip.file(`Page_${i + 1}.png`, base64Data, { base64: true });
                    
                    const progress = ((i + 1) / totalFiles) * 100;
                    progressBar.style.width = progress + '%';
                    render();
                    
                    // Yield to the event loop so the browser can repaint the progress bar.
                    await sleep(0);
                }
                
                state.progressText = 'Generating compressed ZIP file, please wait...';
                progressBar.style.width = '100%';
                render();

                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `archive_${timestamp}.zip`;

                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error('ZIP creation error:', error);
                showError('Error creating ZIP file: ' + error.message);
            } finally {
                state.isConverting = false;
                progressBarContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                state.progressText = '';
                downloadZipBtn.disabled = false;
                render();
            }
        }
        
        // --- Helper Functions ---
        function showError(message) {
            state.errorText = message;
            render();
        }
            
        function hideError() {
            state.errorText = '';
            render();
        }
        
        function resetState() {
            state.file = null;
            state.fileName = '';
            state.isConverting = false;
            state.resultsVisible = false;
            state.progressText = '';
            state.convertedImages = [];
            progressBarContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            hideError();
            fileInput.value = ""; 
            resultsList.innerHTML = ''; 
            render();
        }

        // --- Initialization ---
        function init() {
            if (typeof pdfjsLib === 'undefined' || typeof JSZip === 'undefined') {
                showError("Required libraries could not be loaded. Please check your internet connection.");
                return;
            }
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

            // Add Event Listeners
            fileInput.addEventListener('change', handleFileSelect);
            resetBtn.addEventListener('click', resetState);
            convertBtn.addEventListener('click', processPDF);
            downloadZipBtn.addEventListener('click', downloadZip);
            
            const handleDragClass = (e, add) => {
                e.preventDefault();
                e.stopPropagation();
                const label = uploadArea.firstElementChild;
                label.classList.toggle('border-indigo-600', add);
                label.classList.toggle('border-slate-400', !add);
                label.classList.toggle('dark:border-indigo-300', add);
                label.classList.toggle('dark:border-slate-500', !add);
            };
            ['dragenter', 'dragover'].forEach(ev => uploadArea.addEventListener(ev, e => handleDragClass(e, true)));
            ['dragleave', 'drop'].forEach(ev => uploadArea.addEventListener(ev, e => handleDragClass(e, false)));
            uploadArea.addEventListener('drop', (e) => {
                const droppedFile = e.dataTransfer.files[0];
                if(droppedFile){
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect({target: fileInput});
                }
            });

            render();
        }
        
        init();
    });
</script>

</body>
</html>
